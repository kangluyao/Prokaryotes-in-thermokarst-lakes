put -r E:/sequence_data/thermokarst_lakes/lakeshores/MGQS-BJ-20210802-00001_P-20210726-000221/XQ-20210726-00054/bacteria_V4_1/qualified/ /home/data/ibcas_share/meta-analysis/meta_data/lakeshors/

###########################################
=============Lakeshores data analysis=================
###########################################

conda activate qiime2-2020.8

#tibet_sequences
cd lakeshors/
#import data
qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path lakeshores_manifest.csv \
  --output-path lakeshores.qza \
  --input-format PairedEndFastqManifestPhred33

#quality check using qiime2
qiime demux summarize \
  --i-data lakeshores.qza \
  --o-visualization lakeshores.qzv


#去除引物和合并同时进行，以及去噪
nohup qiime dada2 denoise-paired \
--i-demultiplexed-seqs lakeshores.qza \
--p-trunc-len-f 240 \
--p-trunc-len-r 230 \
--p-trim-left-f 19 \
--p-trim-left-r 20 \
--p-max-ee-f 2 \
--p-max-ee-r 2 \
--p-trunc-q 2 \
--p-chimera-method consensus \
--p-min-fold-parent-over-abundance 1 \
--p-n-threads 80 \
--o-table lakeshores-dada2-table.qza \
--o-representative-sequences lakeshores-dada2-rep-seqs.qza \
--o-denoising-stats lakeshores-dada2-stats.qza \
&

qiime demux summarize \
  --i-data lakeshores-dada2-table.qza \
  --o-visualization lakeshores-dada2-table.qzv

#de novo clustering to OTUs（如果不聚类成OTU,则这一步不需要进行）
qiime vsearch cluster-features-de-novo \
  --i-table lakeshores-dada2-table.qza \
  --i-sequences lakeshores-dada2-rep-seqs.qza \
  --p-perc-identity 0.97 \
  --o-clustered-table lakeshores-table-dada2-dn-97.qza \
  --o-clustered-sequences lakeshores-rep-seqs-dada2-dn-97.qza \
  --verbose

#quality check using qiime2
qiime demux summarize \
  --i-data lakeshores-rep-seqs-dada2-dn-97.qza \
  --o-visualization lakeshores-rep-seqs-dada2-dn-97.qzv
  
  
#构建进化树用于多样性分析
nohup qiime phylogeny align-to-tree-mafft-fasttree \
  --i-sequences lakeshores-rep-seqs-dada2-dn-97.qza \
  --p-n-threads 80 \
  --o-alignment aligned-lakeshores-rep-seqs-dn-97.qza \
  --o-masked-alignment masked-aligned-lakeshores-rep-seqs-dn-97.qza \
  --o-tree lakeshores-unrooted-tree-dn-97.qza \
  --o-rooted-tree lakeshores-rooted-tree-dn-97.qza \
&

cd ..

#导入序列和分类文件
qiime tools import \
--type 'FeatureData[Sequence]' \
--input-path Silva/SILVA_132_QIIME_release/rep_set/rep_set_16S_only/99/silva_132_99_16S.fna \
--output-path 99-meta-data/ref_99_seqs_16S.qza


qiime tools import \
--type 'FeatureData[Taxonomy]' \
--input-format HeaderlessTSVTaxonomyFormat \
--input-path Silva/SILVA_132_QIIME_release/taxonomy/16S_only/99/majority_taxonomy_7_levels.txt \
--output-path 99-meta-data/ref_99_otus_16S_taxonomy.qza

#提取参考序列Extract reference reads
qiime feature-classifier extract-reads \
  --i-sequences ref_99_seqs_16S.qza \
  --p-f-primer GTGCCAGCMGCCGCGGTAA \
  --p-r-primer GGACTACHVGGGTWTCTAAT \
  --p-trunc-len 250 \
  --p-min-length 100 \
  --p-max-length 400 \
  --o-reads ref-seqs_16S_V4.qza


#训练分类器Train the classifier
qiime feature-classifier fit-classifier-naive-bayes \
  --i-reference-reads ref-seqs_16S_V4.qza \
  --i-reference-taxonomy ref_99_otus_16S_taxonomy.qza \
  --o-classifier classifier_v4.qza
cd ..

#==========	物种注释Test the classifier	===================
qiime feature-classifier classify-sklearn \
  --i-classifier classifier_v4.qza \
  --i-reads lakeshores-rep-seqs-dada2-dn-97.qza  \
  --o-classification lakeshores-rep-seqs-dada2-dn-97-taxonomy.qza


#===========	otu table filter	===============

#===Remove chloroplast and mitochondria=====   
qiime taxa filter-table \
--i-table lakeshores-table-dada2-dn-97.qza \
--i-taxonomy lakeshores-rep-seqs-dada2-dn-97-taxonomy.qza \
--p-exclude mitochondria,chloroplast \
--o-filtered-table lakeshores-table-nomito-nochloro.qza


#==remove feature frequency less than 10 ====

qiime feature-table filter-features \
--i-table lakeshores-table-nomito-nochloro.qza \
--p-min-frequency 10 \
--p-min-samples 2 \
--o-filtered-table lakeshores-table-nomito-nochloro-frequency10.qza

qiime feature-table summarize \
--i-table lakeshores-table-nomito-nochloro-frequency10.qza \
--o-visualization lakeshores-table-nomito-nochloro-frequency10.qzv


#=====	Export unrarefied data =========
mkdir -p data_from_qiime2/data_unrarefied
qiime tools export \
--input-path lakeshores-table-nomito-nochloro-frequency10.qza \
--output-path data_from_qiime2/data_unrarefied

# Convert biom format to tab-separated text format:
biom convert \
-i data_from_qiime2/data_unrarefied/feature-table.biom \
-o data_from_qiime2/data_unrarefied/otu_table.tsv \
--to-tsv

# Export representative sequences:
qiime tools export \
--input-path lakeshores-rep-seqs-dada2-dn-97.qza \
--output-path data_from_qiime2/data_unrarefied

# Export taxonomy table:
qiime tools export \
--input-path lakeshores-rep-seqs-dada2-dn-97-taxonomy.qza \
--output-path data_from_qiime2/data_unrarefied

# Export tree file:
qiime tools export \
--input-path lakeshores-rooted-tree-dn-97.qza \
--output-path data_from_qiime2/data_unrarefied

#=====	Export rarefied data =========
#Rarefaction
qiime feature-table rarefy \
--i-table lakeshores-table-nomito-nochloro-frequency10.qza \
--p-sampling-depth 33859 \
--o-rarefied-table table-filtered-mindepth.qza

mkdir -p data_from_qiime2/data_rarefy
qiime tools export \
--input-path table-filtered-mindepth.qza \
--output-path data_from_qiime2/data_rarefy

# Convert biom format to tab-separated text format:
biom convert \
-i data_from_qiime2/data_rarefy/feature-table.biom \
-o data_from_qiime2/data_rarefy/otu_table.tsv \
--to-tsv

# Export representative sequences:
qiime tools export \
--input-path lakeshores-rep-seqs-dada2-dn-97.qza \
--output-path data_from_qiime2/data_rarefy

# Export taxonomy table:
qiime tools export \
--input-path lakeshores-rep-seqs-dada2-dn-97-taxonomy.qza \
--output-path data_from_qiime2/data_rarefy

# Export tree file:
qiime tools export \
--input-path lakeshores-rooted-tree-dn-97.qza \
--output-path data_from_qiime2/data_rarefy

